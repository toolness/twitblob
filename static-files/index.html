<!DOCTYPE html>
<html debug="true">
<head>
  <title>Twitblob Documentation</title>
  <style>
  body {
    font-family: Baskerville, Georgia, serif;
    font-size: 12pt;
  }

  #content {
    width: 40em;
    margin: 0 auto;
  }

  code, pre {
    font-family: Monaco, Lucida Console, monospace;
    font-size: 9pt;
  }

  a {
    color: inherit;
  }

  a:hover {
   background: yellow;
  }

  #twitter-login {
    cursor: pointer;
    display: block;
    margin: 0 auto;
  }
  </style>
</head>
<body>
<div id="content">
  <h2><em>Twitblob</em></h2>
  <p><em>Twitblob</em> is a simple cross-origin RESTful API that gives
  all Twitter users a small amount of public JSON blob storage on a
  host server. It also handles three-legged Twitter OAuth key
  exchange, allowing web pages to add social functionality with
  minimum fuss.</p>
  <h3>Requirements</h3>
  <p>The browser using <em>Twitblob</em> must support cross-origin
  <code>XMLHttpRequest</code> and the <code>postMessage</code>
    API. Support for a client-side storage API such as
   <code>localStorage</code> is also recommended for persisting
   authentication tokens.</p>
  <h3>Getting Started</h3>
  <p>The following code provides functions to perform basic operations with
   the <em>Twitblob</em> API.</p>
  <p>This code is actually evaluated in the context of this Web page,
   so you can use your browser's JavaScript Console to inspect or
   change the values of variables and call functions. If your browser
   doesn't have a JavaScript Console, use <a id="fblite"
    href="#fblite">Firebug Lite</a>.</p>
  <p>First, we define a global variable called <code>server</code>
  which holds the base URL for the <em>Twitblob</em> API:</p>
  <pre>
  var server = 'https://secure.toolness.com/api/twitblob';</pre>
  <p>The above URL is just the author's personal <em>Twitblob</em>
    server. You can change it to a different one using your JavaScript
    Console.</p>
  <p>We also define a global called <code>twitblob</code> which
  will eventually contain the authentication information for the
  <em>Twitblob</em> service:</p>
  <pre>
  var twitblob = null;</pre>
  <p>We'll now define a <code>login()</code> function that opens
  a popup window which guides the end-user through Twitter
  authentication, saving the credentials in the <code>twitblob</code>
  global when finished.</p>
  <pre>
  function login() {
    var popup = window.open(server + '/login/', 'login',
                            'width=640,height=480');
    window.addEventListener('message', function msg(event) {
      if (event.source == popup) {
        popup.close();
        window.removeEventListener('message', msg, false);
        twitblob = JSON.parse(event.data);
        console.log("logged in", twitblob);
      }
    }, false);
  }</pre>
  <p>You can click on the image below to trigger this function.</p>
  <img id="twitter-login" src="sign-in-with-twitter-d.png"
       onclick="login()">
  <p>Finally, we'll define two functions that allow us to update and
  retrieve the currently logged-in user's JSON blob.</p>
  <pre>
  function updateBlob(obj) {
    var req = new XMLHttpRequest();
    req.open('POST', server + '/blobs/' + twitblob.screen_name);
    req.onload = function() {
      console.log("updated blob", JSON.parse(req.responseText));
    }
    req.send(JSON.stringify({token: twitblob.token, data: obj}));
  }

  function getBlob() {
    var req = new XMLHttpRequest();
    req.open('GET', server + '/blobs/' + twitblob.screen_name);
    req.onload = function() {
      console.log("got blob", JSON.parse(req.responseText));
    }
    req.send(null);
  }</pre>
  <p>Play around with these functions in your JavaScript Console to
    get a feel for how they work. Note that issuing a
    <code>POST</code> request to the <em>Twitblob</em> API will
    effectively overwrite only the key-value pairs mentioned in the
    object sent; if you want to completely replace the user's whole
    JSON blob, issue a <code>PUT</code> request instead.</p>
  <h3>Limitations</h3>
  <p><em>Twitblob</em> has not been tested for use with
   status.net's Twitter-compatibile API.</p>
</div>
<script>
onload = function() {
  var elems = document.querySelectorAll("pre");
  for (var i = 0; i < elems.length; i++) {
    var script = document.createElement("script");
    script.textContent = elems[i].textContent;
    document.body.appendChild(script);
  }

  var fblite = document.getElementById("fblite");
  fblite.addEventListener("click", function(event) {
    event.preventDefault();
    var script = document.createElement("script");
    script.src = "https://getfirebug.com/firebug-lite.js";
    document.body.appendChild(script);
  }, false);
}
</script>
</body>
</html>
